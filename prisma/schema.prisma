// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider   = "prisma-client-js" // or "prisma-client"
  engineType = "client"
  output     = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------
// ENUMS
// ---------------------------------------------------------

enum Rol {
  ADMINISTRADOR
  COORDINADOR
  ALUMNO
}

enum Turno {
  MATUTINO
  VESPERTINO
}

enum TipoCiclo {
  SEMESTRAL
  CUATRIMESTRAL
  ANUAL
}

enum Fase {
  FISICO_MATEMATICO
  QUIMICO_BIOLOGO
  SOCIALES
}

// ---------------------------------------------------------
// MODELOS
// ---------------------------------------------------------

model Escuela {
  id_escuela Int     @id @default(autoincrement())
  nombre     String
  clave      String?
  estado     Boolean @default(true)

  // Relaciones
  planes        PlanDeEstudio[]
  departamentos Departamento[]
  usuarios      Usuario[]
  generaciones  Generacion[]
  grupos        Grupo[] // opcional pero útil

  @@map("escuela")
}

// ---------------------------------------------------------

model PlanDeEstudio {
  id_plan      Int       @id @default(autoincrement())
  nombre       String
  descripcion  String?
  fecha_inicio DateTime
  fecha_fin    DateTime?
  id_escuela   Int

  // Relaciones
  escuela      Escuela            @relation(fields: [id_escuela], references: [id_escuela])
  ciclos       Ciclo[]
  generaciones Generacion[]
  planDeptos   PlanDepartamento[]
  grupos       Grupo[]

  @@map("plan_de_estudio")
}

// ---------------------------------------------------------

model Ciclo {
  id_ciclo     Int       @id @default(autoincrement())
  nombre       String
  fecha_inicio DateTime
  fecha_fin    DateTime
  tipo         TipoCiclo
  activo       Boolean   @default(false)
  id_plan      Int

  // Relaciones
  plan        PlanDeEstudio     @relation(fields: [id_plan], references: [id_plan])
  grupos      Grupo[]
  actividades Actividad[]
  alumnoActs  AlumnoActividad[]

  @@map("ciclo")
}

// ---------------------------------------------------------

model Generacion {
  id_generacion Int    @id @default(autoincrement())
  nombre        String
  ano_inicio    Int
  ano_fin       Int
  id_plan       Int
  id_escuela    Int

  // Relaciones
  plan    PlanDeEstudio @relation(fields: [id_plan], references: [id_plan])
  escuela Escuela       @relation(fields: [id_escuela], references: [id_escuela])
  grupos  Grupo[]
  alumnos Usuario[]

  @@map("generacion")
}

// ---------------------------------------------------------

model Departamento {
  id_departamento Int     @id @default(autoincrement())
  nombre          String
  descripcion     String?
  id_escuela      Int

  // Relaciones
  escuela     Escuela            @relation(fields: [id_escuela], references: [id_escuela])
  actividades Actividad[]
  planDeptos  PlanDepartamento[]

  @@map("departamento")
}

// ---------------------------------------------------------

model Usuario {
  id_usuario Int     @id @default(autoincrement())
  num_cuenta String  @unique
  nip        String
  nombre     String
  correo     String?
  rol        Rol
  id_escuela Int
  id_grupo   Int?
  activo     Boolean @default(true)

  // Relaciones
  escuela                 Escuela           @relation(fields: [id_escuela], references: [id_escuela])
  grupo                   Grupo?            @relation(fields: [id_grupo], references: [id_grupo])
  actividades_creadas     Actividad[]       @relation("CoordinadorActividad")
  registros_act           AlumnoActividad[] @relation("AlumnoParticipacion")
  registros_puntos        AlumnoActividad[] @relation("CoordinadorRegistro")
  logs                    RegistroCambios[]
  generacion              Generacion?       @relation(fields: [generacionId_generacion], references: [id_generacion])
  generacionId_generacion Int?
  clubes_miembro          ClubMiembro[]     @relation("AlumnoClub")
  clubes_puntos           ClubPuntosRegistro[] @relation("AlumnoClubPuntos")
  clubes_puntos_coord     ClubPuntosRegistro[] @relation("CoordinadorClubPuntos")

  @@map("usuario")
}

// ---------------------------------------------------------

model Grupo {
  id_grupo      Int     @id @default(autoincrement())
  nombre        String
  nivel         Int
  turno         Turno
  id_generacion Int
  id_ciclo      Int
  id_plan       Int
  id_escuela    Int
  fase          Fase?
  activo        Boolean @default(true)

  // Relaciones
  generacion Generacion    @relation(fields: [id_generacion], references: [id_generacion])
  ciclo      Ciclo         @relation(fields: [id_ciclo], references: [id_ciclo])
  plan       PlanDeEstudio @relation(fields: [id_plan], references: [id_plan])
  escuela    Escuela       @relation(fields: [id_escuela], references: [id_escuela])
  alumnos    Usuario[]

  @@map("grupo")
}

// ---------------------------------------------------------

model Actividad {
  id_actividad    Int      @id @default(autoincrement())
  nombre          String
  descripcion     String?
  fecha           DateTime
  puntos          Int
  id_departamento Int
  id_coordinador  Int
  id_ciclo        Int

  // Relaciones
  departamento Departamento      @relation(fields: [id_departamento], references: [id_departamento])
  coordinador  Usuario           @relation("CoordinadorActividad", fields: [id_coordinador], references: [id_usuario])
  ciclo        Ciclo             @relation(fields: [id_ciclo], references: [id_ciclo])
  alumnoActs   AlumnoActividad[]

  @@map("actividad")
}

// ---------------------------------------------------------

model AlumnoActividad {
  id_alumno_actividad Int      @id @default(autoincrement())
  id_alumno           Int
  id_actividad        Int
  puntos_otorgados    Int
  fecha_registro      DateTime
  id_coordinador      Int
  id_ciclo            Int

  // Relaciones
  alumno      Usuario   @relation("AlumnoParticipacion", fields: [id_alumno], references: [id_usuario])
  actividad   Actividad @relation(fields: [id_actividad], references: [id_actividad])
  coordinador Usuario   @relation("CoordinadorRegistro", fields: [id_coordinador], references: [id_usuario])
  ciclo       Ciclo     @relation(fields: [id_ciclo], references: [id_ciclo])

  @@map("alumno_actividad")
}

// ---------------------------------------------------------

model PlanDepartamento {
  id_plan_departamento Int @id @default(autoincrement())
  id_plan              Int
  id_departamento      Int
  puntos_requeridos    Int

  // Relaciones
  plan         PlanDeEstudio @relation(fields: [id_plan], references: [id_plan])
  departamento Departamento  @relation(fields: [id_departamento], references: [id_departamento])

  @@map("plan_departamento")
}

// ---------------------------------------------------------

model RegistroCambios {
  id_registro Int      @id @default(autoincrement())
  id_usuario  Int
  modulo      String
  accion      String
  descripcion String?
  fecha       DateTime @default(now())

  // Relaciones
  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])

  @@map("registro_cambios")
}

// ======================================
// ============   CLUBES    =============
// ======================================

model Club {
  id_club        Int      @id @default(autoincrement())
  nombre         String
  descripcion    String?
  fecha_creacion DateTime @default(now())

  reglas    ClubRegla[]
  miembros  ClubMiembro[]
  registros ClubPuntosRegistro[]

  @@map("club")
}

// --------------------------------------

model ClubRegla {
  id_regla       Int      @id @default(autoincrement())
  id_club        Int
  nombre         String
  descripcion    String?
  puntos         Int // Puntos que asigna la regla
  tipo           String // Ej: "asistencia", "participación", "mensual", etc.
  fecha_creacion DateTime @default(now())

  // Relaciones
  club      Club                 @relation(fields: [id_club], references: [id_club])
  registros ClubPuntosRegistro[]

  @@map("club_regla")
}

// --------------------------------------

model ClubMiembro {
  id_miembro    Int      @id @default(autoincrement())
  id_club       Int
  id_alumno     Int
  fecha_ingreso DateTime @default(now())
  estado        String   @default("ACTIVO") // ACTIVO | INACTIVO

  // Relaciones
  club   Club    @relation(fields: [id_club], references: [id_club])
  alumno Usuario @relation("AlumnoClub", fields: [id_alumno], references: [id_usuario])

  @@unique([id_club, id_alumno]) // Un alumno no puede duplicarse en un club
  @@map("club_miembro")
}

// --------------------------------------

model ClubPuntosRegistro {
  id_registro      Int      @id @default(autoincrement())
  id_club          Int
  id_regla         Int
  id_alumno        Int
  puntos_otorgados Int
  fecha_registro   DateTime @default(now())
  id_coordinador   Int

  // Relaciones
  club        Club      @relation(fields: [id_club], references: [id_club])
  regla       ClubRegla @relation(fields: [id_regla], references: [id_regla])
  alumno      Usuario   @relation("AlumnoClubPuntos", fields: [id_alumno], references: [id_usuario])
  coordinador Usuario   @relation("CoordinadorClubPuntos", fields: [id_coordinador], references: [id_usuario])

  @@map("club_puntos_registro")
}
